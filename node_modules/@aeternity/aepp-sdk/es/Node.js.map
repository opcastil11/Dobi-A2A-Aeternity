{"version":3,"file":"Node.js","names":["userAgentPolicyName","setClientRequestIdPolicyName","genRequestQueuesPolicy","genCombineGetRequestsPolicy","genErrorFormatterPolicy","parseBigIntPolicy","genVersionCheckPolicy","genRetryOnFailurePolicy","Node","NodeApi","UnsupportedVersionError","ConsensusProtocolVersion","_ignoreVersion","WeakMap","_cachedStatusPromise","_isHyperchainPromise","constructor","url","ignoreVersion","retryCount","retryOverallDelay","options","getVersion","opts","_getCachedStatus","nodeVersion","allowInsecureConnection","additionalPolicies","body","reason","errorCode","join","_classPrivateFieldInitSpec","_classPrivateFieldSet","pipeline","addPolicy","phase","removePolicy","name","_classPrivateFieldGet","getStatus","args","promise","then","_isHyperchain","getHyperchainContractPubkeys","requestOptions","customHeaders","error","message","getNetworkId","networkId","getNodeInfo","nodeNetworkId","protocols","topBlockHeight","consensusProtocolVersion","filter","effectiveAtHeight","reduce","acc","p","version","toString","versions","Object","values","el","map","geVersion","Math","min","ltVersion","max","console","warn","$host"],"sources":["../src/Node.ts"],"sourcesContent":["// eslint-disable-next-line max-classes-per-file\nimport { OperationOptions } from '@azure/core-client';\nimport { userAgentPolicyName, setClientRequestIdPolicyName } from '@azure/core-rest-pipeline';\nimport {\n  genRequestQueuesPolicy,\n  genCombineGetRequestsPolicy,\n  genErrorFormatterPolicy,\n  parseBigIntPolicy,\n  genVersionCheckPolicy,\n  genRetryOnFailurePolicy,\n} from './utils/autorest.js';\nimport { Node as NodeApi, NodeOptionalParams, ErrorModel } from './apis/node/index.js';\nimport { UnsupportedVersionError } from './utils/errors.js';\nimport { ConsensusProtocolVersion } from './tx/builder/constants.js';\n\ninterface NodeInfo {\n  url: string;\n  nodeNetworkId: string;\n  version: string;\n  consensusProtocolVersion: ConsensusProtocolVersion;\n}\n\n/**\n * @category chain\n */\nexport default class Node extends NodeApi {\n  readonly #ignoreVersion: boolean;\n\n  /**\n   * @param url - Url for node API\n   * @param options - Options\n   * @param options.ignoreVersion - Print warning instead of throwing exception if node\n   * or consensus protocol version is not supported, use with caution\n   * @param options.retryCount - Amount of extra requests to do in case of failure\n   * @param options.retryOverallDelay - Time in ms to wait between all retries\n   */\n  constructor(\n    url: string,\n    {\n      ignoreVersion = false,\n      retryCount = 3,\n      retryOverallDelay = 800,\n      ...options\n    }: NodeOptionalParams & {\n      ignoreVersion?: boolean;\n      retryCount?: number;\n      retryOverallDelay?: number;\n    } = {},\n  ) {\n    const getVersion = async (opts: OperationOptions): Promise<string> =>\n      (await this._getCachedStatus(opts)).nodeVersion;\n    // eslint-disable-next-line constructor-super\n    super(url, {\n      allowInsecureConnection: true,\n      additionalPolicies: [\n        genVersionCheckPolicy('node', getVersion, '7.1.0', '8.0.0', ignoreVersion),\n        genRequestQueuesPolicy(),\n        genCombineGetRequestsPolicy(),\n        genRetryOnFailurePolicy(retryCount, retryOverallDelay),\n        genErrorFormatterPolicy((body: ErrorModel) =>\n          [' ', body.reason, body.errorCode == null ? '' : ` (${body.errorCode})`].join(''),\n        ),\n      ],\n      ...options,\n    });\n    this.#ignoreVersion = ignoreVersion;\n    this.pipeline.addPolicy(parseBigIntPolicy, { phase: 'Deserialize' });\n    this.pipeline.removePolicy({ name: userAgentPolicyName });\n    this.pipeline.removePolicy({ name: setClientRequestIdPolicyName });\n    // TODO: use instead our retry policy\n    this.pipeline.removePolicy({ name: 'defaultRetryPolicy' });\n  }\n\n  #cachedStatusPromise?: ReturnType<NodeApi['getStatus']>;\n\n  async _getCachedStatus(options?: OperationOptions): ReturnType<NodeApi['getStatus']> {\n    if (this.#cachedStatusPromise != null) return this.#cachedStatusPromise;\n    return this.getStatus(options);\n  }\n\n  override async getStatus(\n    ...args: Parameters<NodeApi['getStatus']>\n  ): ReturnType<NodeApi['getStatus']> {\n    const promise = super.getStatus(...args);\n    promise.then(\n      () => {\n        this.#cachedStatusPromise = promise;\n      },\n      () => {},\n    );\n    return promise;\n  }\n\n  #isHyperchainPromise?: Promise<boolean>;\n\n  async _isHyperchain(): Promise<boolean> {\n    if (this.#isHyperchainPromise != null) return this.#isHyperchainPromise;\n    this.#isHyperchainPromise = this.getHyperchainContractPubkeys({\n      requestOptions: { customHeaders: { '__no-retry': 'true' } },\n    }).then(\n      () => true,\n      (error) => {\n        if (error.message !== 'v3/hyperchain/contracts error: 404 status code') throw error;\n        return false;\n      },\n    );\n    return this.#isHyperchainPromise;\n  }\n\n  /**\n   * Returns network ID provided by node.\n   * This method won't do extra requests on subsequent calls.\n   */\n  async getNetworkId(): Promise<string> {\n    return (await this._getCachedStatus()).networkId;\n  }\n\n  async getNodeInfo(): Promise<NodeInfo> {\n    const {\n      nodeVersion,\n      networkId: nodeNetworkId,\n      protocols,\n      topBlockHeight,\n    } = await this.getStatus();\n\n    const consensusProtocolVersion = protocols\n      .filter(({ effectiveAtHeight }) => topBlockHeight >= effectiveAtHeight)\n      .reduce((acc, p) => (p.effectiveAtHeight > acc.effectiveAtHeight ? p : acc), {\n        effectiveAtHeight: -1,\n        version: 0,\n      }).version;\n    if (ConsensusProtocolVersion[consensusProtocolVersion] == null) {\n      const version = consensusProtocolVersion.toString();\n      const versions = Object.values(ConsensusProtocolVersion)\n        .filter((el) => typeof el === 'number')\n        .map((el) => +el);\n      const geVersion = Math.min(...versions).toString();\n      const ltVersion = (Math.max(...versions) + 1).toString();\n      const error = new UnsupportedVersionError(\n        'consensus protocol',\n        version,\n        geVersion,\n        ltVersion,\n      );\n      if (this.#ignoreVersion) console.warn(error.message);\n      else throw error;\n    }\n\n    return {\n      url: this.$host,\n      nodeNetworkId,\n      version: nodeVersion,\n      consensusProtocolVersion,\n    };\n  }\n}\n"],"mappings":";;;;;AAAA;;AAEA,SAASA,mBAAmB,EAAEC,4BAA4B,QAAQ,2BAA2B;AAC7F,SACEC,sBAAsB,EACtBC,2BAA2B,EAC3BC,uBAAuB,EACvBC,iBAAiB,EACjBC,qBAAqB,EACrBC,uBAAuB,QAClB,qBAAqB;AAC5B,SAASC,IAAI,IAAIC,OAAO,QAAwC,sBAAsB;AACtF,SAASC,uBAAuB,QAAQ,mBAAmB;AAC3D,SAASC,wBAAwB,QAAQ,2BAA2B;AAAC,IAAAC,cAAA,oBAAAC,OAAA;AAAA,IAAAC,oBAAA,oBAAAD,OAAA;AAAA,IAAAE,oBAAA,oBAAAF,OAAA;AASrE;AACA;AACA;AACA,eAAe,MAAML,IAAI,SAASC,OAAO,CAAC;EAGxC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;EACEO,WAAWA,CACTC,GAAW,EACX;IACEC,aAAa,GAAG,KAAK;IACrBC,UAAU,GAAG,CAAC;IACdC,iBAAiB,GAAG,GAAG;IACvB,GAAGC;EAKL,CAAC,GAAG,CAAC,CAAC,EACN;IACA,MAAMC,UAAU,GAAG,MAAOC,IAAsB,IAC9C,CAAC,MAAM,IAAI,CAACC,gBAAgB,CAACD,IAAI,CAAC,EAAEE,WAAW;IACjD;IACA,KAAK,CAACR,GAAG,EAAE;MACTS,uBAAuB,EAAE,IAAI;MAC7BC,kBAAkB,EAAE,CAClBrB,qBAAqB,CAAC,MAAM,EAAEgB,UAAU,EAAE,OAAO,EAAE,OAAO,EAAEJ,aAAa,CAAC,EAC1EhB,sBAAsB,CAAC,CAAC,EACxBC,2BAA2B,CAAC,CAAC,EAC7BI,uBAAuB,CAACY,UAAU,EAAEC,iBAAiB,CAAC,EACtDhB,uBAAuB,CAAEwB,IAAgB,IACvC,CAAC,GAAG,EAAEA,IAAI,CAACC,MAAM,EAAED,IAAI,CAACE,SAAS,IAAI,IAAI,GAAG,EAAE,GAAG,KAAKF,IAAI,CAACE,SAAS,GAAG,CAAC,CAACC,IAAI,CAAC,EAAE,CAClF,CAAC,CACF;MACD,GAAGV;IACL,CAAC,CAAC;IAtCJW,0BAAA,OAASpB,cAAc;IA+CvBoB,0BAAA,OAAAlB,oBAAoB;IAoBpBkB,0BAAA,OAAAjB,oBAAoB;IA5BlBkB,qBAAA,CAAKrB,cAAc,EAAnB,IAAI,EAAkBM,aAAJ,CAAC;IACnB,IAAI,CAACgB,QAAQ,CAACC,SAAS,CAAC9B,iBAAiB,EAAE;MAAE+B,KAAK,EAAE;IAAc,CAAC,CAAC;IACpE,IAAI,CAACF,QAAQ,CAACG,YAAY,CAAC;MAAEC,IAAI,EAAEtC;IAAoB,CAAC,CAAC;IACzD,IAAI,CAACkC,QAAQ,CAACG,YAAY,CAAC;MAAEC,IAAI,EAAErC;IAA6B,CAAC,CAAC;IAClE;IACA,IAAI,CAACiC,QAAQ,CAACG,YAAY,CAAC;MAAEC,IAAI,EAAE;IAAqB,CAAC,CAAC;EAC5D;EAIA,MAAMd,gBAAgBA,CAACH,OAA0B,EAAoC;IACnF,IAAIkB,qBAAA,CAAKzB,oBAAoB,EAAzB,IAAwB,CAAC,IAAI,IAAI,EAAE,OAAOyB,qBAAA,CAAKzB,oBAAoB,EAAzB,IAAwB,CAAC;IACvE,OAAO,IAAI,CAAC0B,SAAS,CAACnB,OAAO,CAAC;EAChC;EAEA,MAAemB,SAASA,CACtB,GAAGC,IAAsC,EACP;IAClC,MAAMC,OAAO,GAAG,KAAK,CAACF,SAAS,CAAC,GAAGC,IAAI,CAAC;IACxCC,OAAO,CAACC,IAAI,CACV,MAAM;MACJV,qBAAA,CAAKnB,oBAAoB,EAAzB,IAAI,EAAwB4B,OAAJ,CAAC;IAC3B,CAAC,EACD,MAAM,CAAC,CACT,CAAC;IACD,OAAOA,OAAO;EAChB;EAIA,MAAME,aAAaA,CAAA,EAAqB;IACtC,IAAIL,qBAAA,CAAKxB,oBAAoB,EAAzB,IAAwB,CAAC,IAAI,IAAI,EAAE,OAAOwB,qBAAA,CAAKxB,oBAAoB,EAAzB,IAAwB,CAAC;IACvEkB,qBAAA,CAAKlB,oBAAoB,EAAzB,IAAI,EAAwB,IAAI,CAAC8B,4BAA4B,CAAC;MAC5DC,cAAc,EAAE;QAAEC,aAAa,EAAE;UAAE,YAAY,EAAE;QAAO;MAAE;IAC5D,CAAC,CAAC,CAACJ,IAAI,CACL,MAAM,IAAI,EACTK,KAAK,IAAK;MACT,IAAIA,KAAK,CAACC,OAAO,KAAK,gDAAgD,EAAE,MAAMD,KAAK;MACnF,OAAO,KAAK;IACd,CACF,CARwB,CAAC;IASzB,OAAOT,qBAAA,CAAKxB,oBAAoB,EAAzB,IAAwB,CAAC;EAClC;;EAEA;AACF;AACA;AACA;EACE,MAAMmC,YAAYA,CAAA,EAAoB;IACpC,OAAO,CAAC,MAAM,IAAI,CAAC1B,gBAAgB,CAAC,CAAC,EAAE2B,SAAS;EAClD;EAEA,MAAMC,WAAWA,CAAA,EAAsB;IACrC,MAAM;MACJ3B,WAAW;MACX0B,SAAS,EAAEE,aAAa;MACxBC,SAAS;MACTC;IACF,CAAC,GAAG,MAAM,IAAI,CAACf,SAAS,CAAC,CAAC;IAE1B,MAAMgB,wBAAwB,GAAGF,SAAS,CACvCG,MAAM,CAAC,CAAC;MAAEC;IAAkB,CAAC,KAAKH,cAAc,IAAIG,iBAAiB,CAAC,CACtEC,MAAM,CAAC,CAACC,GAAG,EAAEC,CAAC,KAAMA,CAAC,CAACH,iBAAiB,GAAGE,GAAG,CAACF,iBAAiB,GAAGG,CAAC,GAAGD,GAAI,EAAE;MAC3EF,iBAAiB,EAAE,CAAC,CAAC;MACrBI,OAAO,EAAE;IACX,CAAC,CAAC,CAACA,OAAO;IACZ,IAAInD,wBAAwB,CAAC6C,wBAAwB,CAAC,IAAI,IAAI,EAAE;MAC9D,MAAMM,OAAO,GAAGN,wBAAwB,CAACO,QAAQ,CAAC,CAAC;MACnD,MAAMC,QAAQ,GAAGC,MAAM,CAACC,MAAM,CAACvD,wBAAwB,CAAC,CACrD8C,MAAM,CAAEU,EAAE,IAAK,OAAOA,EAAE,KAAK,QAAQ,CAAC,CACtCC,GAAG,CAAED,EAAE,IAAK,CAACA,EAAE,CAAC;MACnB,MAAME,SAAS,GAAGC,IAAI,CAACC,GAAG,CAAC,GAAGP,QAAQ,CAAC,CAACD,QAAQ,CAAC,CAAC;MAClD,MAAMS,SAAS,GAAG,CAACF,IAAI,CAACG,GAAG,CAAC,GAAGT,QAAQ,CAAC,GAAG,CAAC,EAAED,QAAQ,CAAC,CAAC;MACxD,MAAMf,KAAK,GAAG,IAAItC,uBAAuB,CACvC,oBAAoB,EACpBoD,OAAO,EACPO,SAAS,EACTG,SACF,CAAC;MACD,IAAIjC,qBAAA,CAAK3B,cAAc,EAAnB,IAAkB,CAAC,EAAE8D,OAAO,CAACC,IAAI,CAAC3B,KAAK,CAACC,OAAO,CAAC,CAAC,KAChD,MAAMD,KAAK;IAClB;IAEA,OAAO;MACL/B,GAAG,EAAE,IAAI,CAAC2D,KAAK;MACfvB,aAAa;MACbS,OAAO,EAAErC,WAAW;MACpB+B;IACF,CAAC;EACH;AACF","ignoreList":[]}