{"version":3,"file":"RpcClient.js","names":["RpcError","RpcInternalError","RpcMethodNotFoundError","InvalidRpcMessageError","MissingCallbackError","ensureError","_callbacks","WeakMap","_messageId","_methods","_RpcClient_brand","WeakSet","RpcClient","constructor","connection","onDisconnect","methods","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","Map","_classPrivateFieldSet","connect","_assertClassBrand","_handleMessage","bind","request","name","params","_sendRequest","call","_classPrivateFieldGet","Promise","resolve","reject","set","notify","undefined","msg","origin","jsonrpc","JSON","stringify","_processResponse","result","error","method","methodName","e","id","_sendResponse","sendMessage","toJSON","callbacks","get","deserialize","delete"],"sources":["../../../src/aepp-wallet-communication/rpc/RpcClient.ts"],"sourcesContent":["import { RpcError, RpcInternalError, RpcMethodNotFoundError } from '../schema.js';\nimport BrowserConnection from '../connection/Browser.js';\nimport { InvalidRpcMessageError, MissingCallbackError } from '../../utils/errors.js';\nimport { ensureError } from '../../utils/other.js';\n\ninterface JsonRpcRequest {\n  jsonrpc: '2.0';\n  id: number;\n  method: string;\n  params?: any;\n}\n\ninterface JsonRpcResponse {\n  jsonrpc: '2.0';\n  id: number;\n  method: string;\n  result?: any;\n  error?: {\n    code: number;\n    message: string;\n    data?: any;\n  };\n}\n\ntype RpcApiHandler = (p?: any) => any | undefined;\ntype RpcApi<Api> = { [k in keyof Api]: RpcApiHandler };\ntype WithOrigin<Api extends RpcApi<Api>> = {\n  [k in keyof Api]: (p: Parameters<Api[k]>[0], origin: string) => ReturnType<Api[k]>;\n};\n\n/**\n * Contain functionality for using RPC conection\n * @category aepp wallet communication\n * @param connection - Connection object\n * @param onDisconnect - Disconnect callback\n * @param methods - Object containing handlers for each request by name\n */\nexport default class RpcClient<\n  RemoteApi extends RpcApi<RemoteApi>,\n  LocalApi extends RpcApi<LocalApi>,\n> {\n  connection: BrowserConnection;\n\n  readonly #callbacks = new Map<\n    number,\n    { resolve: (v: any) => void; reject: (e: Error) => void }\n  >();\n\n  #messageId = 0;\n\n  readonly #methods: WithOrigin<LocalApi>;\n\n  constructor(\n    connection: BrowserConnection,\n    onDisconnect: () => void,\n    methods: WithOrigin<LocalApi>,\n  ) {\n    this.connection = connection;\n    this.#methods = methods;\n    connection.connect(this.#handleMessage.bind(this), onDisconnect);\n  }\n\n  async #handleMessage(msg: JsonRpcRequest | JsonRpcResponse, origin: string): Promise<void> {\n    if (msg?.jsonrpc !== '2.0') throw new InvalidRpcMessageError(JSON.stringify(msg));\n    if ('result' in msg || 'error' in msg) {\n      this.#processResponse(msg);\n      return;\n    }\n\n    const request = msg as JsonRpcRequest;\n    let result;\n    let error: Error | undefined;\n    try {\n      if (!(request.method in this.#methods)) throw new RpcMethodNotFoundError();\n      const methodName = request.method as keyof LocalApi;\n      result = await this.#methods[methodName](request.params, origin);\n    } catch (e) {\n      ensureError(e);\n      error = e;\n    }\n    if (request.id != null) {\n      this.#sendResponse(\n        request.id,\n        request.method as keyof LocalApi,\n        result,\n        error == null || error instanceof RpcError ? error : new RpcInternalError(),\n      );\n    }\n    if (error != null && !(error instanceof RpcError)) throw error;\n  }\n\n  #sendRequest(\n    id: number | undefined,\n    method: keyof RemoteApi | keyof LocalApi,\n    params?: any,\n  ): void {\n    this.connection.sendMessage({\n      jsonrpc: '2.0',\n      ...(id != null ? { id } : {}),\n      method,\n      ...(params != null ? { params } : {}),\n    });\n  }\n\n  #sendResponse(\n    id: number,\n    method: keyof RemoteApi | keyof LocalApi, // TODO: remove as far it is not required in JSON RPC\n    result?: any,\n    error?: RpcError,\n  ): void {\n    this.connection.sendMessage({\n      jsonrpc: '2.0',\n      id,\n      method,\n      ...(error != null ? { error: error.toJSON() } : { result }),\n    });\n  }\n\n  /**\n   * Make a request\n   * @param name - Method name\n   * @param params - Method params\n   * @returns Promise which will be resolved after receiving response message\n   */\n  async request<Name extends keyof RemoteApi>(\n    name: Name,\n    params: Parameters<RemoteApi[Name]>[0],\n  ): Promise<ReturnType<RemoteApi[Name]>> {\n    this.#sendRequest((this.#messageId += 1), name, params);\n    return new Promise((resolve, reject) => {\n      this.#callbacks.set(this.#messageId, { resolve, reject });\n    });\n  }\n\n  /**\n   * Make a notification\n   * @param name - Method name\n   * @param params - Method params\n   */\n  notify<Name extends keyof RemoteApi>(name: Name, params: Parameters<RemoteApi[Name]>[0]): void {\n    this.#sendRequest(undefined, name, params);\n  }\n\n  /**\n   * Process response message\n   * @param msg - Message object\n   */\n  #processResponse({ id, error, result }: { id: number; error?: any; result?: any }): void {\n    const callbacks = this.#callbacks.get(id);\n    if (callbacks == null) throw new MissingCallbackError(id);\n    if (error != null) callbacks.reject(RpcError.deserialize(error));\n    else callbacks.resolve(result);\n    this.#callbacks.delete(id);\n  }\n}\n"],"mappings":"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","ignoreList":[]}